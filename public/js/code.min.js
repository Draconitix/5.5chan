var app=angular.module("Chan",["ngResource","ui.router","ngCookies","angular-jwt","ngDialog","uiCropper"]);app.config(function($interpolateProvider){$interpolateProvider.startSymbol("{[{"),$interpolateProvider.endSymbol("}]}")}),app.config(["$qProvider",function($qProvider){$qProvider.errorOnUnhandledRejections(!1)}]),app.config(function(ngDialogProvider){ngDialogProvider.setForceBodyReload(!0)}),app.config(function($stateProvider){$stateProvider.state("login",{url:"/login",templateUrl:"/partials/login.html",controller:"loginState"}).state("register",{url:"/register",templateUrl:"/partials/register.html",controller:"registerState"}).state("interface",{url:"/interface",templateUrl:"/partials/interface.html",controller:"interfaceState"}).state("profile",{url:"/profile",templateUrl:"/partials/profile.html",controller:"profileState"})}).run(function($state){$state.go("login")}),app.controller("interfaceState",function($scope,$state,$cookies,interface,jwtHelper,formInputValidate,$sce,messageParser,$window,mediaApi,$rootScope){var token=$cookies.get("accessToken");void 0===token&&$state.go("login"),$scope.user=jwtHelper.decodeToken(token),$scope.logout=function(){$cookies.remove("accessToken"),$state.go("login")};var currentReqStart=0,currentReqEnd=0;$scope.chatrooms=[],$scope.joined=void 0!=$cookies.get("chatroom")&&$cookies.get("chatroom"),$scope.joinedUsers=[],$scope.posts=[],$scope.joinChat=function(name){$scope.messages=[],interface.join(name),interface.getMessages(name).then(function(res){currentReqStart=res.length,currentReqEnd=currentReqStart-30,res.map(function(e,i){i>=currentReqEnd&&i<=currentReqStart&&$scope.messages.push(e)}),$scope.messages.map(function(e,i){var time=new Date(e.sentAt);e.date=getDate(time),e.editing=!1})})},interface.getUsersProfile().then(function(res){$scope.usersUriArr=res,console.log(res),$scope.getProfileUri=function(username){var test;return $scope.usersUriArr.map(function(e,i){e.username==username&&(test=1==e.cropped?e.uri+"cropped.png":1==e.thumb?e.uri+"thumb."+e.type:e.uri+"original."+e.type)}),test}},function(err){console.log(err)}),$scope.leaveChat=function(){interface.leave($scope.joined),$scope.joined=!1,$scope.messages=[]};interface.userPromiseCb(function(data){if(1==data.addUser){console.log(data.user.username);var existsNum=0;if($scope.joinedUsers.map(function(e,i){e.username==data.user.username&&(existsNum++,console.log("exists"))}),0==existsNum){var dt=new Date(Date.now());$scope.joinedUsers.push({username:data.user.username,uri:data.user.uri,type:data.user.type}),$scope.messages.push({date:getDate(dt),sentAt:Date.now(),parts:[{type:"alert",user:data.user.username,alert:"has joined the chatroom."}],editing:!1}),$scope.$apply()}}0==data.addUser&&$scope.joinedUsers.map(function(e,i){if(e.username==data.user.username){var dt=new Date(Date.now());$scope.joinedUsers.splice(i,1),$scope.messages.push({date:getDate(dt),sentAt:Date.now(),parts:[{type:"alert",user:data.user.username,alert:"has left the chatroom."}],editing:!1}),$scope.$apply()}}),"multiple"===data.addUser&&($scope.joinedUsers=data.users)});interface.promise(function(err){err?(console.log(err),"update"==err&&refrRooms()):($scope.joined=$cookies.get("chatroom"),$scope.$apply(),refrRooms())});var refrRooms=function(){interface.getRooms().then(function(res){$scope.chatrooms=res},function(err){console.log(err)})},refrUsers=function(type){interface.getUsers().then(function(res){var usrArr=[];usrArr[0]="wait";for(var i=0;i<res.length;i++)$scope.user.username==res[i].username?usrArr[0]={username:$scope.user.username,creator:!0,included:!0}:usrArr.push({username:res[i].username,creator:!1,included:!1});if("add"==type&&($scope.addUsers=usrArr),"edit"==type&&($scope.editUsers=usrArr,$scope.editroom.users!=[]))for(i=0;i<$scope.editUsers.length;i++)void 0!=$scope.editroom.users[i]&&$scope.editroom.users[i]==$scope.editUsers[i].username&&($scope.editUsers[i].included=!0)},function(err){console.log(err)})};refrRooms(),$scope.newroom={name:"",private:!1,users:[]},$scope.addErrs={name:"",private:"",users:""},$scope.adding=!1,$scope.addUsers=[],$scope.toggleCreate=function(){$scope.adding=1!=$scope.adding},refrUsers("add");var messageScroll,injectUsers=function(type){var arr,array,obj;"add"==type&&($scope.newroom.users=[],array=$scope.newroom.users,obj=$scope.newroom,arr=$scope.addUsers),"edit"==type&&($scope.editroom.users=[],array=$scope.editroom.users,obj=$scope.editroom,arr=$scope.editUsers);for(var i=0;i<arr.length;i++)1==arr[i].included?array.push(arr[i].username):1==arr[i].creator&&(obj.creator=arr[i].username)};$scope.createRoom=function(){var data,src=$scope.newroom;1==$scope.newroom.private?(injectUsers("add"),data=src):data={name:$scope.newroom.name,private:$scope.newroom.private,users:[]};var errs=formInputValidate.check(data);0==errs.num?(console.log(data),interface.createRoom(data).then(function(res){refrRooms(),$scope.adding=!1},function(err){console.log(err)})):console.log(errs)},$scope.deleteRoom=function(name){interface.deleteRoom({name:name}).then(function(res){refrRooms(),$scope.editing=!1},function(err){console.log(err)})},$scope.editInitial={},$scope.editroom={},$scope.editing=!1,$scope.editUsers=[],$scope.toggleEdit=function(index){0==$scope.editing?($scope.editing=!0,$scope.editroom=$scope.chatrooms[index],$scope.editInitial=angular.copy($scope.chatrooms[index]),refrUsers("edit")):($scope.editing=!1,refrRooms())},$scope.editRoom=function(){var data,src=$scope.editroom;1==src.private?(injectUsers("edit"),data=src,console.log(data)):data={name:src.name,private:src.private,users:[],user:$scope.user.username};var errs=formInputValidate.check(data);0==errs.num?interface.editRoom($scope.editInitial,$scope.editroom).then(function(res){$scope.editing=!1},function(err){console.log(err)}):console.log(errs)},0!=$scope.joined&&($scope.messages=[],interface.join($scope.joined),interface.getMessages($scope.joined).then(function(res){$scope.messages=[],currentReqStart=res.length,currentReqEnd=currentReqStart-25,res.map(function(e,i){i>=currentReqEnd&&i<=currentReqStart&&$scope.messages.push(e)}),$scope.messages.map(function(e,i){var time=new Date(e.sentAt);e.date=getDate(time),e.editing=!1})})),$(".messageChatArea, .msgAreaParent, .message").ready(function(){messageScroll=new PerfectScrollbar(".msgAreaParent",{wheelSpeed:3})});var scroll=function(){messageScroll.update(),$(".messageAreaParent, .messageChatArea, .message").ready(function(){var elem=document.getElementsByClassName("msgAreaParent")[0],y=$(".msgAreaParent").scrollTop(),hInit=$(".messageChatArea").innerHeight()-$(".msgAreaParent").outerHeight(),h=Math.round(hInit),range=h-350;$scope.atBottom=range<=y&&y<=h,1==$scope.atBottom?(console.log("scrolled to bottom"),$(".msgAreaParent").animate({scrollTop:elem.scrollHeight},600)):($rootScope.newMsgCount++,$scope.$apply())})};$rootScope.newMsgCount=0,$scope.atBottom,$scope.scrollToBottom=function(){var hInit=$(".messageChatArea").innerHeight()-$(".msgAreaParent").outerHeight(),h=Math.round(hInit);$(".msgAreaParent").animate({scrollTop:h},600)},$scope.$watch("atBottom",function(newV,oldV){0==oldV&&1==newV&&($rootScope.newMsgCount=0,console.log("reset new msg count"))}),$scope.messages=[],$scope.trustUrl=function(url){return $sce.trustAsResourceUrl(url)},$scope.message={text:""},$scope.sendMessage=function(event){if(""!=$scope.message.text&&13===event.keyCode){interface.send($scope.message.text,function(res){var dt=new Date(res.sentAt);res.date=getDate(dt),res.editing=!1,console.log(res),$scope.messages.push(res)}),$scope.message.text="",scroll()}};var getDate=function(date){var year=date.getFullYear(),month=(1+date.getMonth()).toString();month=month.length>1?month:"0"+month;var day=date.getDate().toString();day=day.length>1?day:"0"+day;var hours=date.getHours(),minutes=date.getMinutes(),ampm=hours>=12?"pm":"am",strTime=(hours=(hours%=12)||12)+":"+(minutes=minutes<10?"0"+minutes:minutes)+" "+ampm;return["January","February","March","April","May","June","July","August","September","October","November","December"][month-1]+" "+Math.round(day)+", "+year+" "+strTime};$("#msgAreaParent").scroll(function(){document.getElementById("msgAreaParent")}),interface.incoming(function(msgData){var dt=new Date(Date.now());msgData.date=getDate(dt),msgData.editing=!1,$scope.messages.push(msgData),$scope.$apply(),scroll()}),$scope.editMessage=function(query,pos){var m=$scope.messages[pos],newParts=messageParser(query.edit),q={_id:m._id,chatroom:m.chatroom,text:m.text},d={parts:newParts,user:m.user,chatroom:m.chatroom,sentAt:m.sentAt,text:query.edit};interface.editMessage(q,d).then(function(res){m.parts=newParts,m.text=query.edit,m.editing=!1,console.log(newParts)},function(err){console.log(err)})},$scope.deleteMessage=function(query){console.log(query),interface.delMessage(query).then(function(res){$scope.messages.map(function(e,i){query==e&&$scope.messages.splice(i,1)})},function(err){console.log(err)})};interface.msgEditPromise(function(id,text,parts){console.log(id+"  "+text+" "+parts),$scope.messages.map(function(e,i){e._id==id&&($scope.messages[i].parts=parts,$scope.messages[i].text=text,$scope.$apply())})}),interface.msgDelPromise(function(id){console.log(id),$scope.messages.map(function(e,i){console.log(e._id+" "+id),e._id==id&&($scope.messages.splice(i,1),$scope.$apply())})}),$scope.sidebarExpanded=!1,$scope.sidebarToggle=function(){0==$scope.sidebarExpanded?($scope.sidebarExpanded=!0,$(".chatAreaWindow").addClass("chatWindowExpanded"),$(".apiSearchArea").addClass("chatWindowExpanded"),$(".chatSidebar").addClass("sidebarExpanded"),$(".chatSidebar").removeClass("sidebarCollapsed")):1==$scope.sidebarExpanded&&($scope.sidebarExpanded=!1,$(".chatAreaWindow").removeClass("chatWindowExpanded"),$(".apiSearchArea").removeClass("chatWindowExpanded"),$(".chatSidebar").removeClass("sidebarExpanded"),$(".chatSidebar").addClass("sidebarCollapsed"))},$scope.apiResults=[],$scope.searchToggleBool=!1,$scope.searchToggle=function(){0==$scope.searchToggleBool?$scope.searchToggleBool=!0:$scope.searchToggleBool=!1},$scope.vidSearch=function(keyword){mediaApi.videos(keyword).then(function(res){console.log(res),$scope.apiResults.length>0&&$scope.apiResults.length<50?$scope.apiResults=$scope.apiResults.concat(res):$scope.apiResults=res},function(err){console.log(err)})},$scope.imgSearch=function(keyword){mediaApi.images(keyword).then(function(res){console.log(res),$scope.apiResults.length>0?$scope.apiResults=$scope.apiResults.concat(res):$scope.apiResults=res},function(err){console.log(err)})},$scope.gifSearch=function(keyword){mediaApi.gifs(keyword).then(function(res){console.log(res),$scope.apiResults.length>0?$scope.apiResults=$scope.apiResults.concat(res):$scope.apiResults=res},function(err){console.log(err)})},$scope.addToMsg=function(uri){$scope.message.text=$scope.message.text+" "+uri,$scope.apiResults.map(function(e,i){e.viewed=!1}),$scope.searchToggle(),$scope.apiResults=[],$scope.$apply(),console.log($scope.apiResults)},$scope.validate=function(input,field){var obj={};if(obj[field]=input,void 0!=input){var errs=formInputValidate.check(obj);errs.num>0?($scope.addErrs[field]=errs[field],console.log(JSON.stringify(errs[field]))):"username"===field?input!=$scope.user.username&&input!=$scope.user.email&&formInputValidate.taken(field,input).then(function(res){if(0!=res.length){var fullStr=field.charAt(0).toUpperCase()+field.split(field[0])[1]+" is already taken.";$scope.addErrs[field]=fullStr}else $scope.addErrs[field]=""}):$scope.addErrs[field]=""}}}),app.controller("loginState",function(login,$scope,$state,formInputValidate,$cookies){void 0!=$cookies.get("accessToken")&&$state.go("interface"),$scope.loginMain=function(){var errors=formInputValidate.check($scope.user);if(0==errors.num){var loginData={username:$scope.user.username,password:$scope.user.password};loginData.password=sha256(loginData.password),login(loginData).then(function(response){$state.go("profile")},function(error){$scope.errors.main="User not found."})}else $scope.errors=errors},$scope.user={username:"",password:""},$scope.errors={},$scope.validate=function(input,field){var obj={};if(obj[field]=input,void 0!=input){var errs=formInputValidate.check(obj);errs.num>0?($scope.errors[field]=errs[field],console.log(JSON.stringify(errs[field]))):$scope.errors[field]=""}}}),app.controller("profileState",function($scope,$cookies,jwtHelper,$state,assets,ngDialog,profile,formInputValidate,profile){void 0==$cookies.get("accessToken")&&$state.go("login");var token=$cookies.get("accessToken");$scope.user=jwtHelper.decodeToken(token),$scope.eUser={username:$scope.user.username,email:$scope.user.email,desc:$scope.user.desc},$scope.userImgUri="",$scope.imgUriFolder="",$scope.imgType="",$scope.editing=!1,$scope.errors={},$scope.profileLoading=!1,$scope.currentFile="",$scope.changeFile=function(files){$scope.currentFile=files[0],$scope.$apply()},$scope.toggleEdit=function(){0==$scope.editing?$scope.editing=!0:$scope.editing=!1},$scope.put=function(){var formData=new FormData,errors=formInputValidate.check($scope.eUser);console.log(errors),0==/(\.jpg|\.JPG|\.JPEG|\.jpeg|\.png|\.PNG|\.gif|\.GIF)$/g.test($scope.currentFile.name)&&""!=$scope.currentFile&&(errors.num+=1,$scope.errors.profile="Profile image must be a image file",console.log("file error")),0==errors.num?(formData.append("username",$scope.eUser.username),formData.append("email",$scope.eUser.email),formData.append("desc",$scope.eUser.desc),""!=$scope.currentFile&&formData.append("profile",$scope.currentFile),profile.edit(formData).then(function(response){$state.go("profile"),refresh()},function(error){console.log(error)})):($scope.errors=errors,0==/(\.jpg|\.JPG|\.JPEG|\.jpeg|\.png|\.PNG|\.gif|\.GIF)$/g.test($scope.currentFile.name)&&""!=$scope.currentFile&&($scope.errors.profile="Profile image must be a image file"))},$scope.saveCrop=function(){assets.crop($scope.user.username,$scope.cropped.image).then(function(response){console.log(response)},function(err){console.log(err)}),ngDialog.closeAll(),$scope.userImgUri=$scope.cropped.image},$scope.del=function(){profile.remove().then(function(res){console.log(res),$state.go("login")})},$scope.crop=function(){ngDialog.open({template:"partials/directives/cropper.html",scope:$scope,width:"100vw",height:"70vh",showClose:!1})},$scope.validate=function(input,field){var obj={};if(obj[field]=input,void 0!=input){var errs=formInputValidate.check(obj);errs.num>0?($scope.errors[field]=errs[field],console.log(JSON.stringify(errs[field]))):"username"===field||"email"===field?input!=$scope.user.username&&input!=$scope.user.email&&formInputValidate.taken(field,input).then(function(res){if(0!=res.length){var fullStr=field.charAt(0).toUpperCase()+field.split(field[0])[1]+" is already taken.";$scope.errors[field]=fullStr}else $scope.errors[field]=""}):$scope.errors[field]=""}},$scope.canCrop=!1,assets.get($scope.user.username,"profile").then(function(response){1==response.thumb?(1==response.cropped?$scope.userImgUri=response.uri+"cropped.png":$scope.userImgUri=response.uri+"default."+response.type,$scope.imgUriFolder=response.uri,$scope.imgType=response.type,console.log(response.scaled),1==response.scaled?$scope.canCrop=!0:$scope.canCrop=!1,$scope.cropped={source:response.uri+"scaled."+response.type},console.log(response)):$scope.userImgUri=response.uri+"original."+response.type},function(err){console.log(err)}),$scope.logout=function(){$cookies.remove("accessToken"),$state.go("login")};var gAdding=!1;$scope.galleryLoading=!0,$scope.galleryDText="Remove images from gallery",$scope.galleryT=!1,$scope.galleryD=!1,$scope.gallery=[];$scope.gChangeFile=function(files){0==gAdding&&($scope.gCurrentFiles=files,$scope.$apply())},$scope.addToGallery=function(){gAdding=!0,$scope.galleryLoading=!0;var maxLimit=$scope.gCurrentFiles.length,currentFiles=$scope.gCurrentFiles,i=0,fullRes=[],main=function(){var fd=new FormData;fd.append("file",currentFiles[i]),assets.create(fd).then(function(res){fullRes.push(res),loop()},function(err){console.log(err),loop()}),i++},loop=function(){i<=maxLimit-1&&main(),i==maxLimit&&(gAdding=!1,console.log("rn"),setTimeout(function(){galleryData(),$scope.galleryLoading=!1,$scope.gCurrentFiles=[]},2e3))};$scope.gCurrentFiles.length>0&&main()},$scope.galleryToggle=function(){0==$scope.galleryT?$scope.galleryT=!0:$scope.galleryT=!1};var galleryData=function(){assets.get($scope.user.username,"gallery").then(function(res){!function(res){if(console.log(res),Array.isArray(res)){$scope.gallery=[];for(var i=0;i<res.length;i++)$scope.gallery.push(res[i]),console.log(res[i].uri),res.length}else $scope.gallery=[],$scope.gallery.push(res),console.log("notArray"),$scope.$apply()}(res),$scope.galleryLoading=!1},function(err){console.log(err)})};$scope.galleryDelToggle=function(){0==$scope.galleryD?($scope.galleryD=!0,$scope.galleryDText="Stop removing images from gallery"):($scope.galleryD=!1,$scope.galleryDText="Remove images from gallery")},galleryData(),$scope.galleryDel=function(){var maxLimit=$scope.gallery.length,i=0,main=function(){1==$scope.gallery[i].delete?(assets.remove(JSON.stringify([{uri:$scope.gallery[i].uri,user:$scope.gallery[i].user,filename:$scope.gallery[i].filename}])).then(function(res){console.log(res),loop()},function(err){console.log(err),loop()}),i++):(console.log(i+" not deleting"),i++,loop())},loop=function(){if(i<=maxLimit-1&&(main(),i==maxLimit)){for(var s=maxLimit-1;s>=0;s--)1==$scope.gallery[s].delete&&$scope.gallery.splice(s,1);0==$scope.gallery.length&&($scope.galleryD=!1,$scope.galleryDText="Remove images from gallery")}};maxLimit>0&&main()};var all=!1;$scope.gallerySAText="Select All",$scope.galleryDelSelectAll=function(){0==all?(all=!0,$scope.gallerySAText="Deselect All"):(all=!1,$scope.gallerySAText="Select All");for(var w=0;w<$scope.gallery.length;w++)$scope.gallery[w].delete=all},$scope.setAsProfile=function(imgData){0==$scope.profileLoading&&0==$scope.galleryD&&0==gAdding&&assets.editProfile(imgData).then(function(res){refresh(),galleryData()},function(err){console.log(err)})};var refresh=function(){$scope.profileLoading=!0,token=$cookies.get("accessToken"),$scope.user=jwtHelper.decodeToken(token),$scope.editing=!1,$scope.currentFile="",formData=new FormData,$scope.eUser={username:$scope.user.username,email:$scope.user.email,desc:$scope.user.desc},setTimeout(function(){assets.get($scope.user.username,"profile").then(function(response){1==response.thumb?(1==response.cropped?$scope.userImgUri=response.uri+"cropped.png":$scope.userImgUri=response.uri+"default."+response.type,$scope.imgUriFolder=response.uri,$scope.imgType=response.type,1==response.scaled?$scope.canCrop=!0:$scope.canCrop=!1,$scope.cropped={source:response.uri+"scaled."+response.type},$scope.cropped={source:response.uri+"scaled."+response.type},console.log(response)):$scope.userImgUri=response.uri+"original."+response.type},function(err){console.log(err)}),""!=formData.get("profile")&&galleryData(),$scope.profileLoading=!1},3e3)}}),app.controller("registerState",function($scope,$state,register,formInputValidate,$cookies){void 0!=$cookies.get("accessToken")&&$state.go("interface");var formData=new FormData;$scope.currentFile="",$scope.user={username:"",password:"",email:"",desc:""},$scope.errors={},$scope.changeFile=function(files){$scope.currentFile=files[0],$scope.$apply()},$scope.validate=function(input,field){var obj={};if(obj[field]=input,void 0!=input){var errs=formInputValidate.check(obj);errs.num>0?($scope.errors[field]=errs[field],console.log(JSON.stringify(errs[field]))):"username"===field||"email"===field?formInputValidate.taken(field,input).then(function(res){if(0!=res.length){var fullStr=field.charAt(0).toUpperCase()+field.split(field[0])[1]+" is already taken.";$scope.errors[field]=fullStr}else $scope.errors[field]=""}):$scope.errors[field]=""}},$scope.register=function(){var errors=formInputValidate.check($scope.user);0==/(\.jpg|\.JPG|\.JPEG|\.jpeg|\.png|\.PNG|\.gif|\.GIF)$/g.test($scope.currentFile.name)&&""!=$scope.currentFile&&(errors.num+=1,$scope.errors.profile="Profile image must be a image file"),0==errors.num?(formData.append("username",$scope.user.username),formData.append("password",sha256($scope.user.password)),formData.append("email",$scope.user.email),formData.append("desc",$scope.user.desc),""!=$scope.currentFile&&formData.append("profile",$scope.currentFile),register(formData).then(function(response){$scope.currentFile="",formData=new FormData,$state.go("profile"),$scope.user={username:"",password:"",email:"",desc:""}},function(error){console.log(error)})):($scope.errors=errors,0==/(\.jpg|\.JPG|\.JPEG|\.jpeg|\.png|\.PNG|\.gif|\.GIF)$/g.test($scope.currentFile.name)&&""!=$scope.currentFile&&($scope.errors.profile="Profile image must be a image file"))}}),app.directive("apiSearch",function(){return{restrict:"E",scope:{results:"=results",contentclick:"&",searchvids:"&searchvids",searchimgs:"&searchimgs",searchgifs:"&searchgifs",authorize:"&",toggle:"=toggle"},templateUrl:"partials/directives/apiSearch.html",link:function(scope,elem,attrs){console.log("apiSearch directive ready"),scope.searchType="video",scope.setSearchType=function(type){scope.searchType=type},scope.keyword={input:""},scope.searchError="",scope.search=function(q){q.length>0?("video"==scope.searchType&&scope.searchvids({keyword:q}),"image"==scope.searchType&&scope.searchimgs({keyword:q}),"gif"==scope.searchType&&scope.searchgifs({keyword:q})):scope.searchError="No keyword was passed."}}}}),app.directive("chatMessages",function($location,$anchorScroll,$timeout,$cookies,jwtHelper,$rootScope){var token=$cookies.get("accessToken"),user=jwtHelper.decodeToken(token);return{restrict:"E",scope:{messages:"=messages",authorize:"&",editmessage:"&",delmessage:"&",geturi:"&"},templateUrl:"partials/directives/chat-message.html",link:function(scope,ele,attrs){document.getElementsByClassName("msgAreaParent")[0];$(".messageChatArea, .msgAreaParent").ready(function(){new PerfectScrollbar(".msgAreaParent",{wheelSpeed:3});var h=$(".messageChatArea").height();$(".msgAreaParent").scrollTop(h),document.getElementById("msgAreaParent").addEventListener("ps-scroll-y",function(){var y=$(".msgAreaParent").scrollTop(),hInit=$(".messageChatArea").innerHeight()-$(".msgAreaParent").outerHeight(),h=Math.round(hInit);h-350<=y&&y<=h?($rootScope.newMsgCount=0,$(".chatScrollToBottom").addClass("chatScrollToBottomHidden")):$(".chatScrollToBottom").removeClass("chatScrollToBottomHidden")})}),scope.user=user.username,scope.toggleEdit=function(index){0==scope.messages[index].editing?(scope.messages[index].editing=!0,scope.messages[index].edit=scope.messages[index].text):scope.messages[index].editing=!1},$(".expandSidebar").hover(function(){$(".message").addClass("expandSidebarHover")}),$(".expandSidebar").mouseleave(function(){$(".message").removeClass("expandSidebarHover")})}}}),app.service("assets",function($cookies,$http,$q){var token=$cookies.get("accessToken");return void 0==token?null:{get:function(username,locat){var deferred=$q.defer();return username.length>0?$http({method:"GET",url:"chat/asset/lst",params:{user:username,location:locat},headers:{Authorization:"Bearer "+token}}).then(function(response){"profile"==locat?deferred.resolve(response.data[0]):deferred.resolve(response.data)},function(err){deferred.reject(err)}):(console.log("no username passed"),$http({method:"GET",url:"chat/asset/lst",params:{location:locat},headers:{Authorization:"Bearer "+token}}).then(function(response){deferred.resolve(response.data),console.log("test")},function(err){deferred.reject(err)})),deferred.promise},crop:function(username,data){var deferred=$q.defer();return $http({method:"POST",url:"chat/asset/crop",data:{user:username,data:data},headers:{Authorization:"Bearer "+token}}).then(function(response){console.log(response),deferred.resolve(response.data)},function(err){deferred.reject(err)}),deferred.promise},create:function(files){var deferred=$q.defer();return console.log(files.get("file")),$http({method:"POST",url:"chat/asset/create",transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:"Bearer "+token},data:files}).then(function(response){deferred.resolve(response.data)},function(err){deferred.reject(err)}),deferred.promise},remove:function(query){var deferred=$q.defer();return $http({method:"DELETE",url:"chat/asset/remove",transformRequest:angular.identity,headers:{"Content-Type":"application/json;charset=utf-8",Authorization:"Bearer "+token},data:query}).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise},editProfile:function(data){var deferred=$q.defer();return $http({method:"PUT",url:"chat/asset/update",headers:{Authorization:"Bearer "+token},data:data}).then(function(response){deferred.resolve(response.data)},function(err){deferred.reject(err)}),deferred.promise}}}),app.service("formInputValidate",function($http,$q,$cookies){var fields,data,errorNum=0,errors={username:"",password:"",email:"",firstname:"",lastname:"",desc:"",name:"",users:"",private:""},checkSwitch=function(field){switch(field){case"username":data[field].length<4?(errorNum++,errors[field]="Username must have at least 4 characters."):data[field].length>15&&(errorNum++,errors[field]="Username must be less than 16 characters.");break;case"password":data[field].length<6&&(errorNum++,errors[field]="Password must be at least 6 characters.");break;case"email":0==/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(data[field])&&(errorNum++,errors[field]="Email must be a valid email.");break;case"desc":data[field].length<4?(errorNum++,errors[field]="Description must be at least 4 characters."):data[field].length>250&&(errorNum++,errors[field]="Description must be less than 250 characters.");break;case"firstname":data[field].length>12&&(errorNum++,errors[field]="Firstname must be less than 13 characters.");break;case"lastname":data[field].length>12&&(errorNum++,errors[field]="Lastname must be less than 13 characters.");break;case"name":data[field].length<4?(errorNum++,errors[field]="Name must have at least 4 characters."):data[field].length>20&&(errorNum++,errors[field]="Name must be less than 21 characters.");break;case"private":"boolean"!=typeof data[field]&&(errorNum++,errors[field]="Private must be true or false");break;case"users":for(var u,usrs=data[field];u<data[field].length;u++)1==/[.!@#$%^&*()_\+\-\=]/g.test(usrs[u])&&(errorNum++,errors[field]="Usernames must not contain any special characters");"boolean"==typeof data.private?1==Array.isArray(usrs)?void 0!=usrs.length&&0!=usrs.length||(errorNum++,errors[field]="Users must be added in private chatroom"):(errorNum++,errors[field]="Users field must be an array."):(errorNum++,errors[field]="Users must be validated with private boolean.")}};return{check:function(obj){if(errors={username:"",password:"",email:"",firstname:"",lastname:"",desc:"",name:"",users:"",private:""},errorNum=0,fields=Object.keys(obj),data=obj,fields.length>0)for(var i=0;i<fields.length;i++)if(0==data[fields[i]].length||""==data[fields[i]]||void 0==data[fields[i]]){if("private"!=fields[i]&&"users"!=fields[i]&&"__v"!=fields[i]){errorNum++;var cap=fields[i].charAt(0).toUpperCase()+fields[i].slice(1);errors[fields[i]]=cap+" must not be empty."}}else"email"==fields[i]||"desc"==fields[i]?checkSwitch(fields[i]):(checkSwitch(fields[i]),1==/[.!@#$%^&*()_\+\-\=]/g.test(data[fields[i]])&&"users"!=fields[i]&&(errorNum++,cap=fields[i].charAt(0).toUpperCase()+fields[i].slice(1),errors[fields[i]]=cap+" must not contain any special characters."));else errorNum++,errors.main="Fields must not be empty.";return errors.num=errorNum,errors},taken:function(field,value){var deferred=$q.defer();return"username"===field?$http({method:"GET",url:"chat/user/list",params:{username:value}}).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}):"email"===field&&$http({method:"GET",url:"chat/user/list",params:{email:value}}).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise}}}),app.service("interface",function($cookies,$http,$q,jwtHelper,assets,messageParser){var cbMsg,token=$cookies.get("accessToken"),user=jwtHelper.decodeToken(token),socket=io.connect("",{query:"auth_token="+token});socket.on("message",function(data){cbMsg(data)});var cbPromise,userCbPromise,msgDelPromise,msgEditPromise,getUsersObjsLoop=function(users,cb){var usersDataArr=[],i=0;console.log(users);var max=users.length,main=function(){var currentUser=users[i];assets.get(users[i],"profile").then(function(res){res.length>0?usersDataArr.push({username:currentUser,uri:res.uri,thumb:res.thumb,type:res.type,cropped:res.cropped}):(usersDataArr.push({username:currentUser,uri:"images/defaultUserBg",thumb:!1,type:"png",cropped:!1,default:!0}),console.log("no img found")),loop()},function(err){loop()}),i++},loop=function(){i<=max-1&&main(),i==max&&(cb(usersDataArr),console.log("max"))};main()},promiseCb=function(err){cbPromise(err)},userPromiseCb=function(data){userCbPromise(data)};return socket.on("chatPromise",function(data){if(data.error)promiseCb(data.error);else{$cookies.put("chatroom",data.name),promiseCb();getUsersObjsLoop(data.users,function(dataArr){var nData={users:dataArr,addUser:"multiple"};userPromiseCb(nData)})}}),socket.on("postRoom",function(data){promiseCb("update")}),socket.on("messageDelete",function(data){var msgId;msgId=data._id,msgDelPromise(msgId)}),socket.on("messageEdit",function(data){var msgId,text,parts;console.log("edit cb data.text = "+data.text),msgId=data._id,text=data.text,parts=data.parts,msgEditPromise(msgId,text,parts)}),socket.on("roomUpdate",function(data){if(void 0!=data.user){var users=[];users.push(data.user),getUsersObjsLoop(users,function(dataArr){var nData={user:dataArr[0]};nData.addUser=data.addUser,userPromiseCb(nData)})}}),{promise:function(cb){cbPromise=cb},join:function(room){socket.emit("chatJoin",{chatroom:room,user:user.username})},getRooms:function(){var deferred=$q.defer();return $http({method:"GET",url:"chat/chatroom/list"}).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise},createRoom:function(roomData){var deferred=$q.defer();return $http({method:"POST",url:"chat/chatroom/create",headers:{Authorization:"Bearer "+token},data:roomData}).then(function(res){deferred.resolve(res.data),socket.emit("postRoom",res.data)},function(err){deferred.reject(err)}),deferred.promise},deleteRoom:function(roomData){var deferred=$q.defer();return console.log(roomData),$http({method:"DELETE",url:"chat/chatroom/remove",headers:{Authorization:"Bearer "+token},params:{name:roomData.name,user:user.username}}).then(function(res){deferred.resolve(res.data),socket.emit("postRoom",res.data)},function(err){deferred.reject(err)}),deferred.promise},editRoom:function(query,data){var deferred=$q.defer();return $http({method:"PUT",url:"chat/chatroom/update",headers:{Authorization:"Bearer "+token},params:{name:query.name,user:user.username},data:data}).then(function(res){deferred.resolve(res.data),socket.emit("postRoom",data)},function(err){deferred.reject(err)}),deferred.promise},getUsers:function(){var deferred=$q.defer();return $http({method:"GET",url:"chat/user/list"}).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise},leave:function(room){socket.emit("chatLeave",{chatroom:room,user:user.username}),$cookies.remove("chatroom")},send:function(text,cb){var data,deferred,parts=messageParser(text);(data={parts:parts,user:user.username,text:text,chatroom:$cookies.get("chatroom")},deferred=$q.defer(),$http({method:"POST",url:"chat/post/create",data:data,headers:{Authorization:"Bearer "+token}}).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise).then(function(res){cb(res),socket.emit("sendMessage",res)})},incoming:function(cb){cbMsg=cb},getUsersProfile:function(){var deferred=$q.defer();return assets.get("","profile").then(function(res){var arr=res.map(function(e,i){return{username:e.user,uri:e.uri,type:e.type,thumb:e.thumb,cropped:e.cropped}});deferred.resolve(arr)},function(err){deferred.reject(err)}),deferred.promise},userPromiseCb:function(cb){userCbPromise=cb},getMessages:function(chatroom){var deferred=$q.defer();return $http({method:"GET",url:"chat/post/list",params:{chatroom:chatroom}}).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise},msgPromise:function(cb){cb},editMessage:function(query,data){console.log("data.text "+data.text);var deferred=$q.defer();return $http({method:"PUT",url:"chat/post/update",params:{_id:query._id,chatroom:query.chatroom,text:query.text,user:user.username},data:data,headers:{Authorization:"Bearer "+token}}).then(function(res){deferred.resolve(res.data),console.log("data.text "+data.text),socket.emit("messageUpdate",{msgId:query._id,method:"PUT",text:data.text,parts:data.parts})},function(err){deferred.reject(err)}),deferred.promise},delMessage:function(query){var deferred=$q.defer();return $http({method:"DELETE",url:"chat/post/remove",params:{_id:query._id},headers:{Authorization:"Bearer "+token}}).then(function(res){deferred.resolve(res.data),socket.emit("messageUpdate",{msgId:query._id,method:"DELETE"})},function(err){deferred.reject(err)}),deferred.promise},msgDelPromise:function(cb){msgDelPromise=cb},msgEditPromise:function(cb){msgEditPromise=cb}}}),app.service("login",["$http","$q","$cookies",function($http,$q,$cookies){return function(user){var deferred=$q.defer();return $http({method:"POST",url:"chat/user/login",data:user}).then(function(response){$cookies.put("accessToken",response.data.token),deferred.resolve(response)},function(err){deferred.reject(err)}),deferred.promise}}]),app.service("mediaApi",function($q,$http){var imgStart=1,imgPrevKeyword=null,gifPrevKeyword=null,gifStart=1;return{videos:function(keyword){var deferred=$q.defer();return $http({method:"GET",url:"https://www.googleapis.com/youtube/v3/search",params:{part:"snippet, id",q:keyword,type:"video",key:"AIzaSyABX2iZHGbLKOyYC_xeGliIW29oH4Rv5JM",maxResults:50,safeSearch:"moderate"}}).then(function(res){var vidData=res.data.items.map(function(e,i){return{type:"video",uri:"https://www.youtube.com/embed/"+e.id.videoId,title:e.snippet.title,thumbnailUri:e.snippet.thumbnails.medium.url,viewed:!1}});deferred.resolve(vidData)},function(err){deferred.reject(err)}),deferred.promise},images:function(keyword){var deferred=$q.defer();return imgPrevKeyword==keyword?imgStart+=10:imgStart=1,imgStart<=81?$http({method:"GET",url:"https://www.googleapis.com/customsearch/v1",params:{q:keyword,key:"AIzaSyCrbKJUSKv5nUmjTWDCMAlA0Bi93gUMYH0",cx:"001326175283701008867:blxac3r7dw0",searchType:"image",safe:"high",start:imgStart}}).then(function(res){var imgData=res.data.items.map(function(e,i){return{type:"image",uri:e.link,image:e.image}});deferred.resolve(imgData),imgPrevKeyword=keyword},function(err){deferred.reject(err)}):deferred.reject("Maximum amount of requests fulfilled."),deferred.promise},gifs:function(keyword){var deferred=$q.defer();return gifPrevKeyword==keyword?gifStart+=25:gifStart=1,gifStart<=101?$http({method:"GET",url:"http://api.giphy.com/v1/gifs/search",params:{q:keyword,api_key:"PFOaypSuP2CqECGQZOBGPEoAfzkv3qw1",rating:"pg-13",lang:"en",offset:gifStart}}).then(function(res){var gifData=res.data.data.map(function(e,i){return{type:"gif",thumbnailUri:e.images.fixed_height_small.url,uri:e.images.original.url,height:e.images.fixed_height_small.height,width:e.images.fixed_height_small.width}});deferred.resolve(gifData),gifPrevKeyword=keyword},function(err){deferred.reject(err)}):deferred.reject("Maximum amount of requests fulfilled."),deferred.promise}}}),app.service("messageParser",function(){var partsArray=[],txt={group:[],add:function(){if(txt.group.length>0){var fullText=txt.group[0];if(txt.group.length>1){for(var i=1;i<txt.group.length;i++)fullText=fullText.concat(" ",txt.group[i]);partsArray.push({type:"text",text:fullText}),txt.group=[]}else partsArray.push({type:"text",text:fullText}),txt.group=[]}}},parse=function(part){null!=/\r|\n/.exec(part)&&(txt.add(),part.split("\n").map(function(e,i){e.length>0&&(part=e)}));if(1==/^(http:\/\/|https:\/\/)/g.test(part)){var imgSplit=part.split("."),ext=imgSplit[imgSplit.length-1].toLowerCase();if(/(www\.youtube\.com\/)/g.test(part))if(txt.add(),part.indexOf("watch?v=")>-1){var idSplit=part.split("watch?v=");if(idSplit[1].indexOf("&")>-1){var querySpl=idSplit[1].split("&");partsArray.push({type:"video",url:"https://www.youtube.com/embed/"+querySpl[0]})}else partsArray.push({type:"video",url:"https://www.youtube.com/embed/"+idSplit[1]})}else partsArray.push({type:"video",url:part});else if(1==/(jpg|jpeg|png|gif)/g.test(part))if(txt.add(),1==/(jpg?|jpeg?|png?|gif?)/g.test(part)){var querySplit=part.split(ext+"?");partsArray.push({type:"image",url:querySplit[0]})}else partsArray.push({type:"image",url:part});else txt.add(),partsArray.push({type:"hyperlink",url:part})}else 1==/data:image\/([a-zA-Z]*);base64,([^\"]*)/g.test(part)?(txt.add(),partsArray.push({type:"image",url:part})):txt.group.push(part)};return function(text){partsArray=[];var partition=text.split(" ");console.log(partition);for(var i=0;i<partition.length;i++)if(parse(partition[i]),i==partition.length-1)return txt.add(),partsArray}}),app.service("profile",function($http,$q,$cookies){var token=$cookies.get("accessToken");return{edit:function(userData){var deferred=$q.defer();return $http({method:"PUT",url:"chat/user/update",transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:"Bearer "+token},data:userData}).then(function(response){deferred.resolve(response.data),$cookies.put("accessToken",response.data.token)},function(err){deferred.reject(err)}),deferred.promise},remove:function(){var deferred=$q.defer();return $http({method:"DELETE",url:"chat/user/remove",transformRequest:angular.identity,headers:{Authorization:"Bearer "+token}}).then(function(res){deferred.resolve(res.data),$cookies.remove("accessToken")},function(err){deferred.reject(err)}),deferred.promise}}}),app.service("register",["$http","$q","$cookies",function($http,$q,$cookies){return function(user){var deferred=$q.defer();return $http({method:"POST",url:"chat/user/register",transformRequest:angular.identity,headers:{"Content-Type":void 0},data:user}).then(function(response){$cookies.put("accessToken",response.data.token),deferred.resolve(response)},function(err){deferred.reject(err)}),deferred.promise}}]);